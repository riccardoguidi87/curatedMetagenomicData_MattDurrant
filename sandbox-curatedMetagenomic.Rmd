---
title: "curatedMetagenomic metadata"
output:
  html_document:
    df_print: paged
---

# Data Exploration
use curatedMetagenomicData.tsv to explore data

```{r}
library(tidyverse)
library(readxl)
df <- read_tsv("raw-data/curatedMetagenomicData.tsv")

df %>%
  group_by(study_name,study_condition) %>%
  summarise(count = n())

```
find studies that included an internal control

```{r message=FALSE, warning=FALSE}
df1 <- df %>% 
  group_by(study_name,study_condition) %>%
  summarise(count = n()) %>%
  select(study_name) %>% as.list()
vec <- df1$study_name
studyNamesWithCtr <- vec[ave(seq_along(vec), vec, FUN = length)>1] %>% unique()
studyNamesWithCtr
```
now that I have the list of studies with controls, I'll check the first to make sure my search is accurate
```{r message=FALSE, warning=FALSE}
df %>%
  group_by(study_name,study_condition) %>%
  summarise(count = n()) %>%
  filter(study_name == studyNamesWithCtr[1])
```
the list seems to have worked! Now find CRC studies that include internal Ctrs
```{r message=FALSE, warning=FALSE}
studiesCRCwithCtr <- df %>%
  group_by(study_name,study_condition) %>%
  summarise(count = n()) %>%
  filter(study_name %in% studyNamesWithCtr[1:length(studyNamesWithCtr)]) %>%
  filter(study_condition == "CRC")
studiesCRCwithCtr
```
Save table

```{r}
write_csv(studiesCRCwithCtr,"curated-data/studiesCRCwithCtr.csv")
```


now that I have a table with only CRC studies with included Ctrs, I'll look at their Metadata
```{r message=FALSE, warning=FALSE}
studiesCRCwithCtr$study_name[1]
df %>%
  filter(study_name == studiesCRCwithCtr$study_name[1])
```
# FengQ_2015 
This study is the first study from list with CRC and internal Ctrs. Although there is no annotation in the curatedMetagenomic table, the original article seem to have some I see if I can pull the table and merge. Below is a bunch of code that clean up Clinical table downloaed from original manuscript

```{r message=FALSE, warning=FALSE}
# I confirmed there is lots of data in the published dataset
# curate the table

mdFengQ_2015_SupplData1_1 <- read_excel("raw-data/FengQ_2015_PMID25758642/41467_2015_BFncomms7528_MOESM1193_ESM.xlsx",
                                        skip = 2)
                                        
newHeader <- str_replace(string = names(mdFengQ_2015_SupplData1_1),pattern = "\\.\\.\\..+",replacement = "")

for (i in 1:length(newHeader)){
  hold <- newHeader[i]
  if (newHeader[i+1] == ""){
    newHeader[i+1] <- hold
  }
  # break check
  if (i==51) break
}

names(mdFengQ_2015_SupplData1_1) <- paste0(newHeader,"_",mdFengQ_2015_SupplData1_1[1,])
mdFengQ_2015_SupplData1_2 <- mdFengQ_2015_SupplData1_1[-1,]

names(mdFengQ_2015_SupplData1_2)[48] <- "MLG classifier_Type_Probability of carcinoma"
names(mdFengQ_2015_SupplData1_2)[50] <- "MLG classifier_Type_Probability of advanced adenoma"
names(mdFengQ_2015_SupplData1_2)[52] <- "MLG classifier_Type_Probability of advanced adenoma add age"
names(mdFengQ_2015_SupplData1_2)[1] <- "Sample ID"

names(mdFengQ_2015_SupplData1_2) <- str_replace_all(string = names(mdFengQ_2015_SupplData1_2),pattern = "[[:space:]]|\\(|\\/|\\)|\\:",replacement = "_")

mdFengQ_2015_SupplData1_3 <- mdFengQ_2015_SupplData1_2 %>%
  mutate(across(names(mdFengQ_2015_SupplData1_2[,3:25]), as.integer)) %>%
  mutate(across(names(mdFengQ_2015_SupplData1_2[,26:31]), as.factor)) %>%
  mutate(across(names(mdFengQ_2015_SupplData1_2[,32:38]), as.integer)) %>%
  mutate(across(names(mdFengQ_2015_SupplData1_2[,39:46]), as.factor)) %>%
  mutate(across(names(mdFengQ_2015_SupplData1_2[,47]), as.numeric)) %>%
  mutate(across(names(mdFengQ_2015_SupplData1_2[,48]), as.factor)) %>%
  mutate(across(names(mdFengQ_2015_SupplData1_2[,49]), as.numeric)) %>%
  mutate(across(names(mdFengQ_2015_SupplData1_2[,40]), as.factor))

mdFengQ_2015_SupplData1_3 <- mdFengQ_2015_SupplData1_3 %>%
  mutate(Clinical_data_State = factor(Clinical_data_State, levels=c("controls", "advanced adenoma","carcinoma")))

#edit tables as some muberic are actually factors
mdFengQ_2015_SupplData1_4 <- mdFengQ_2015_SupplData1_3 %>%
  mutate(across(names(mdFengQ_2015_SupplData1_3[,7:9]), as.factor)) %>%
  mutate(across(names(mdFengQ_2015_SupplData1_3[,16:17]), as.factor)) %>%
  mutate(across(names(mdFengQ_2015_SupplData1_3[,24:37]), as.factor)) %>%
  mutate(across(names(mdFengQ_2015_SupplData1_3[,39:46]), as.factor)) %>%
  mutate(across(names(mdFengQ_2015_SupplData1_3[,48]), as.factor)) %>%
  mutate(across(names(mdFengQ_2015_SupplData1_3[,50]), as.factor))


# I have now a well formatted table

mdFengQ_2015_SupplData1_4
```
I can now  vidualize some data for exploration purpose

```{r message=FALSE, warning=FALSE}

# Age across Status
mdFengQ_2015_SupplData1_3 %>%
  mutate(Clinical_data_State = factor(Clinical_data_State, levels=c("controls", "advanced adenoma","carcinoma"))) %>%
  
  ggplot(aes(x = Clinical_data_State,y = `Clinical_data_Age_(yrs)`)) +
  geom_violin(trim = T,na.rm = T) +
  geom_jitter(width = 0.2,size = 1) +
  
  theme_classic()

# BMI across Status
mdFengQ_2015_SupplData1_3 %>%
  mutate(Clinical_data_State = factor(Clinical_data_State, levels=c("controls", "advanced adenoma","carcinoma"))) %>%
  
  ggplot(aes(x = Clinical_data_State,y = Clinical_data_BMI)) +
  geom_violin(trim = T,na.rm = T) +
  geom_jitter(width = 0.2,size = 1) +
  
  theme_classic()

# Sex across Status
mdFengQ_2015_SupplData1_3 %>%
  mutate(Clinical_data_State = factor(Clinical_data_State, levels=c("controls", "advanced adenoma","carcinoma"))) %>%
  group_by(Clinical_data_State,`Clinical_data_Gender_(1:male,_2:female)`) %>%
  summarise(count = n())

# GGT across Status
mdFengQ_2015_SupplData1_3 %>%
  mutate(Clinical_data_State = factor(Clinical_data_State, levels=c("controls", "advanced adenoma","carcinoma"))) %>%
  
  ggplot(aes(x = Clinical_data_State,y = `Clinical_data_GGT_(U/L)`)) +
  geom_violin(trim = T,na.rm = T) +
  geom_jitter(width = 0.2,size = 1) +
  
  theme_classic()

```

## Faster Correlation Visualization
Part of the future work will include the identificationof correlative values between certain Taxa or BGC and metadata. To speed up representation, I divide the variables (columns) between continous and factorial, and adopt differnet plotting strategy to identify linear regression

```{r}
# Loop to print multiple exploratory Plots
## classify variables are numeric or factorial

numericVar <- mdFengQ_2015_SupplData1_4 %>%
  select_if(.predicate = is.numeric) %>% 
  names()

factorialVar <- mdFengQ_2015_SupplData1_4 %>%
  select_if(.predicate = is.factor) %>% 
  names()

#give name to each value in the vectors
numericVar = set_names(numericVar)
factorialVar = set_names(factorialVar)

# make plotting functions
## for continuous data, use scatter
scatter_fun = function(data,x,y){
  ggplot(data, aes(x = .data[[x]], y = .data[[y]])) +
    geom_point(na.rm=TRUE) +
    geom_smooth(method='lm',na.rm=TRUE) +
    theme_bw() +
    theme(axis.text = element_blank(),axis.title = element_text(size = 5))
}
```

After having created vectros with either continous or factorial data (just name holders), and produced the desired scatter plot funciton, I can test the function outside a loop, unsing two arbitrary continous variables 

```{r message=FALSE, warning=FALSE}
# Try functions outside a loop
scatter_fun(data = mdFengQ_2015_SupplData1_4,
           x = "Clinical_data_GPT__ALT___U_L_", y = "Clinical_data_CRP__mg_L_")
```
Then loop through all continous variables and cross-analyze all of them, and Show a single plot from the collection

```{r message=FALSE, warning=FALSE}
# looping through only Scatter Plot data (continuous)
all_plots = map(numericVar, function(resp) {
  map(numericVar, function(i) {
    scatter_fun(data = mdFengQ_2015_SupplData1_4, x = i, y = resp)
  })
})

# print single plot
all_plots$Clinical_data_Age__yrs_$Clinical_data_GGT__U_L_
```

ProduceGroup plots based on the same variables as a y-axis

```{r message=FALSE, warning=FALSE}
colleciton_plots = map(all_plots, ~cowplot::plot_grid(plotlist = .x))
```

```{r message=FALSE, warning=FALSE}
colleciton_plots
```

I can now proceed to produce visuals for factorial data (x-asis) vs continuos data (y-axis) using violin plots

```{r}
## for facterial data, use violin
violin_fun = function(data,x, y) {
  ggplot(data, aes(x = .data[[x]], y = .data[[y]]) ) +
    geom_violin() +
    geom_jitter(size = 1, alpha = 0.5, width = 0.2) +
    theme_bw() +
    theme(axis.text = element_blank(),axis.title = element_text(size = 5))
}

# Try functions outside a loop
violin_fun(data = mdFengQ_2015_SupplData1_4,
           x = "Clinical_data_State", y = "Clinical_data_BMI")
```

Loop through

```{r message=FALSE, warning=FALSE}
# looping through only Violin Plot data (cont vs Factorial)
all_plots2 = map(factorialVar, function(resp) {
  map(numericVar, function(i) {
    violin_fun(data = mdFengQ_2015_SupplData1_4, y = i, x = resp)
  })
})
colleciton_plots2 = map(all_plots2, ~cowplot::plot_grid(plotlist = .x))
```

And print
```{r message=FALSE, warning=FALSE}
colleciton_plots2
```





